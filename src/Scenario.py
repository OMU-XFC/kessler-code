import time
import random

from kesslergame import KesslerGame
from scenario_list import *
from Controller.combined_controller import CombinedController
from controller2023 import Controller

# 隕石が2機体を囲むように，円状に並んで静止する
gen400 = [[0.032452913157350466, 0.24973716114320543, 0.3454197192373851, 0.7501340260834052, 0.9999996640536563, -0.19994252888895184], [0.032452913157350466, 0.24973716114320543, 0.3454197192373851, 0.7501340260834052, 0.9999996640536563, -0.19994252888895184], [0.032452913157350466, 0.24973716114320543, 0.3454197192373851, 0.7501340260834052, 0.9999996640536563, -0.19994252888895184], [0.032452913157350466, 0.24973716114320543, 0.3454197192373851, 0.7501340260834052, 0.9999996640536563, -0.19994252888895184], [0.00014134772881538665, 0.24999879517788717, 0.47952120441809215, 0.7500865770012063, 0.9999999989667893, -0.19625196981331788], [0.00014134772881538665, 0.24999879517788717, 0.47952120441809215, 0.7500865770012063, 0.9999999989667893, -0.19625196981331788], [0.036362196292212684, 0.2447403304850069, 0.4794355045771112, 0.7515383315573292, 0.9999980110627178, -0.19915363462770788], [0.036362196292212684, 0.2447403304850069, 0.4794355045771112, 0.7515383315573292, 0.9999980110627178, -0.19915363462770788], [0.036362196292212684, 0.2447403304850069, 0.4794355045771112, 0.7515383315573292, 0.9999980110627178, -0.19915363462770788], [0.036362196292212684, 0.2447403304850069, 0.4794355045771112, 0.7515383315573292, 0.9999980110627178, -0.19915363462770788], [0.036362196292212684, 0.2447403304850069, 0.4794355045771112, 0.7515383315573292, 0.9999980110627178, -0.19915363462770788], [1.4845944774209016e-06, 0.2500000826786577, 0.5000009686342527, 0.7500838491251883, 0.9999999230953005, 0.048328621058169194], [1.4845944774209016e-06, 0.2500000826786577, 0.5000009686342527, 0.7500838491251883, 0.9999999230953005, 0.048328621058169194], [1.9788802551034687e-06, 0.23034665448300337, 0.5001392291735474, 0.7501246889872011, 0.9999997728180495, -0.02072053260734835], [1.9788802551034687e-06, 0.23034665448300337, 0.5001392291735474, 0.7501246889872011, 0.9999997728180495, -0.02072053260734835], [0.0018104558636598466, 0.24984009860663528, 0.479435517590544, 0.750083706991302, 0.9999998225628368, -0.19923697360285433], [0.0018104558636598466, 0.24984009860663528, 0.479435517590544, 0.750083706991302, 0.9999998225628368, -0.19923697360285433], [0.0018104558636598466, 0.24984009860663528, 0.479435517590544, 0.750083706991302, 0.9999998225628368, -0.19923697360285433], [0.0018104558636598466, 0.24984009860663528, 0.479435517590544, 0.750083706991302, 0.9999998225628368, -0.19923697360285433], [0.03243672230777375, 0.25395321782067043, 0.34541972118299547, 0.7501326650624631, 0.9999998501814943, -0.19069435346691085], [0.03243672230777375, 0.25395321782067043, 0.34541972118299547, 0.7501326650624631, 0.9999998501814943, -0.19069435346691085], [0.03243672230777375, 0.25395321782067043, 0.34541972118299547, 0.7501326650624631, 0.9999998501814943, -0.19069435346691085], [0.03243672230777375, 0.25395321782067043, 0.34541972118299547, 0.7501326650624631, 0.9999998501814943, -0.19069435346691085], [0.03243672230777375, 0.25395321782067043, 0.34541972118299547, 0.7501326650624631, 0.9999998501814943, -0.19086402276276196], [0.03243672230777375, 0.25395321782067043, 0.34541972118299547, 0.7501326650624631, 0.9999998501814943, -0.19069435346691085], [0.03243672230777375, 0.25395321782067043, 0.34541972118299547, 0.7501326650624631, 0.9999998501814943, -0.19069435346691085], [0.035220213709749586, 0.24985059666447737, 0.3454197192373851, 0.7500868467278503, 0.9999991310552511, -0.1996432168520475], [0.03243153193235451, 0.24984917331096387, 0.4795212217541698, 0.7500874104783714, 0.9999999859305666, -0.1992370637868243], [0.03243153193235451, 0.24984917331096387, 0.4795212217541698, 0.7500874104783714, 0.9999999859305666, -0.1992370637868243], [0.00019254623055827563, 0.2506695135126718, 0.47622606691019376, 0.7505195195393524, 0.9999987715484328, -0.19047291969206923], [0.00019254623055827563, 0.2506695135126718, 0.47622606691019376, 0.7505195195393524, 0.9999987715484328, -0.19047291969206923], [0.00019254623055827563, 0.2506695135126718, 0.47622606691019376, 0.7505195195393524, 0.9999987715484328, -0.19047291969206923], [0.00019254623055827563, 0.2506695135126718, 0.47622606691019376, 0.7505195195393524, 0.9999987715484328, -0.19047291969206923], [0.00019254623055827563, 0.2506695135126718, 0.47622606691019376, 0.7505195195393524, 0.9999987715484328, -0.19047291969206923], [2.144670046976262e-06, 0.2549821848521217, 0.501563824765492, 0.7501253112992446, 0.9999999989192725, -0.015615190811645571], [2.144670046976262e-06, 0.2549821848521217, 0.501563824765492, 0.7501253112992446, 0.9999999989192725, -0.015615190811645571], [-4.547451887094535e-06, 0.2550513745880697, 0.501563824765492, 0.7501253447182683, 0.9999999978003814, -0.015141232014331762], [0.0005590044369583828, 0.25075316585373714, 0.4755911921232767, 0.7500831688782174, 0.9999992476237171, -0.18981381590082813], [0.05563241972758393, 0.2821000889814952, 0.35040157010848233, 0.7541641034130506, 0.9999999996062309, -0.19607045290217007], [2.932789013668642e-06, 0.25000013868853527, 0.47944235064199164, 0.7501336966324348, 0.9999998464928271, -0.19086923800390682], [1.6503398465153124e-06, 0.07320382175950715, 0.34481086033232916, 0.750085379491705, 0.9999999998839477, 0.9107913435746238], [1.6503398465153124e-06, 0.07320382175950715, 0.34481086033232916, 0.750085379491705, 0.9999999998839477, 0.9107913435746238], [0.03245793458079349, 0.2500002160084682, 0.3454499487309119, 0.7500845487239469, 0.9999998323574951, -0.19951403113078123], [1.4667629817043167e-06, 0.2500000836637407, 0.4999998051668602, 0.7500838279615698, 0.9999999128655302, 0.04832057425904914], [1.5869050545471622e-06, 0.25000008366269566, 0.49999981372376956, 0.7500838263393811, 0.9999999995332234, 0.04903039889878304], [2.2268076068273084e-06, 0.2500000817362704, 0.4795237852668863, 0.750083078897146, 0.9999999486127187, -0.19604510665379948], [0.05532421223335034, 0.2821000889814952, 0.35040157010848233, 0.7541641034130506, 0.9999999113294679, -0.19607045290217007], [0.05532421223335034, 0.2821000889814952, 0.35040157010848233, 0.7541641034130506, 0.9999999113294679, -0.19607045290217007], [0.036275005846511, 0.24984917239431945, 0.4795212217541698, 0.7501334221000263, 0.9999997033746908, -0.19923707029047208], [0.036275005846511, 0.24984917239431945, 0.4795212217541698, 0.7501334221000263, 0.9999997033746908, -0.19923707029047208], [0.0005732369992273843, 0.25075316585373714, 0.4755911921232767, 0.7500848475656595, 0.9999992476237171, -0.18981381590082813], [0.0005732369992273843, 0.25075316585373714, 0.4755911921232767, 0.7500848475656595, 0.9999992476237171, -0.18981381590082813], [0.003885297227920406, 0.24457520116212, 0.47348870828248224, 0.7515496500281302, 0.9999999607065466, -0.19915806110848872], [1.4602237550410111e-06, 0.2500000836637407, 0.49999981595890636, 0.7500816084516095, 0.9999999183100833, 0.9166636694728896], [0.03641475986972014, 0.2500010733347597, 0.4799055465322077, 0.7501659107083354, 0.999998014716554, -0.19915492995088319], [0.03245793458079349, 0.2500045685528398, 0.3454616506538218, 0.7500845487239469, 0.9999999883937722, -0.1999082195362705], [0.00030176196607814576, 0.25000008373572924, 0.47943778836468026, 0.7500838269051054, 0.9999999142041766, -0.19069247306967785], [1.4721280233314418e-06, 0.25000010054785965, 0.5000010662222815, 0.7500838318710568, 0.9999999668402617, 0.04813044885350693], [1.4721280233314418e-06, 0.25000010054785965, 0.5000010662222815, 0.7500838318710568, 0.9999999668402617, 0.04813044885350693], [0.03245793458079349, 0.2500110533060256, 0.4798975101401785, 0.7501314454840007, 0.9999999869980689, -0.1993796622715418], [1.49337595833545e-06, 0.2500000826815959, 0.5000009942326507, 0.7500813565794923, 0.9999993973766329, 0.04640807716494459], [-1.8341709260114347e-06, 0.2500000836557975, 0.49999981022798223, 0.7500838249568197, 0.9999999129647995, 0.04905240981112844], [0.031757741551174494, 0.25000007782559236, 0.47993639718760045, 0.7500818337352322, 0.999999921401167, -0.19960950629473667], [0.03245793458079349, 0.2500010733347597, 0.47993639718760045, 0.7501340017608054, 0.9999999639715873, -0.19955949644249923], [1.636559917331293e-06, 0.07320382175950715, 0.3447417650033913, 0.750085379491705, 0.9999999997207109, 0.9107913435746238], [2.384528162382104e-06, 0.25000008358412834, 0.49999971790705566, 0.7500816237618599, 0.9999999329882373, 0.9664065098008436], [0.036362196292212684, 0.2447403304850069, 0.4794355045771112, 0.7515383315573292, 0.9999980075859624, -0.19915363462770788], [0.03245793458079349, 0.2500045685528398, 0.3454616506538218, 0.7500845487239469, 0.9999999720686634, -0.1999082195362705], [0.05563241972758393, 0.2821000889814952, 0.35040157010848233, 0.7541641034130506, 0.9999999992006461, -0.19607045290217007], [1.636559917331293e-06, 0.07320382175950715, 0.3447417650033913, 0.750085379491705, 0.9999999997207109, 0.9107913435746238], [2.384528162382104e-06, 0.2500000835839805, 0.5000009935306828, 0.7500816237618599, 0.9999999340949556, 0.9166182290420994], [1.585852733666448e-06, 0.250000083536091, 0.49999981372376956, 0.7500838324541695, 0.999999999721837, 0.048196466871975055], [1.5815020965394757e-06, 0.2500000831287501, 0.4999998140582163, 0.750083826302531, 0.9999999982054254, 0.05283513592416998], [1.6184807379678208e-06, 0.25000005424631255, 0.49999981385133085, 0.750083826302531, 0.9999999982054254, 0.0528217062915491], [0.05532421223335034, 0.2821000889814952, 0.35040157010848233, 0.7541641034130506, 0.9999992621366195, -0.19607045290217007], [0.03243672230777375, 0.25395321782067043, 0.34541972118299547, 0.7501326650624631, 0.9999998492641508, -0.19069435346691085], [0.003887153295196423, 0.24457520116212, 0.47348870828248224, 0.7515496500281302, 0.9999999607065466, -0.19915806110848872], [1.4995987830491789e-06, 0.25000010054785965, 0.5000010662222815, 0.7500838309219002, 0.9999999668402617, 0.04813044885350693], [0.03245793458079349, 0.25000031105441145, 0.3454499487309119, 0.7500845487239469, 0.9999998323574951, -0.19955881229077949], [0.0005743756131986143, 0.25075316585373714, 0.4755911921232767, 0.7500845073010748, 0.999999978523776, -0.18981381590082813], [0.031757741551174494, 0.25000007782559236, 0.47993639718760045, 0.7501339962045431, 0.999999921401167, -0.19960950629473667], [2.144670046976262e-06, 0.2549821848521217, 0.501563824765492, 0.7501253112992446, 0.9999999973991406, -0.015615190811645571], [0.036275005846511, 0.24984917239431945, 0.4795212217541698, 0.7501334221000263, 0.999999687172747, -0.19923707029047208], [-4.123904350164684e-06, 0.2550978830861432, 0.501563824765492, 0.7501251692773496, 0.9999999185308263, -0.015141232014331762], [-2.125473524291181e-06, 0.2500000836637407, 0.49999983559391015, 0.7500838279641926, 0.9999999877935069, 0.04905238748319479], [0.03243153193235451, 0.24984917331113896, 0.4795212217541698, 0.7500879018599813, 0.9999999859305666, -0.19923765052032366], [1.5011925969717754e-06, 0.2500000826815959, 0.5000009942326507, 0.7500838487475858, 0.9999999172190039, 0.048328621058169194], [0.00019254623055827563, 0.2506695135126718, 0.47622606691019376, 0.7505195195393524, 0.9999986415687294, -0.19047291969206923], [0.0003033792973109005, 0.25000008804712776, 0.47943778836468026, 0.7500832587770462, 0.999999996916231, -0.19069247306967785], [1.9838435976419803e-06, 0.23034665448300337, 0.5001430297194803, 0.7501243555275898, 0.9999999936293775, -0.02072053260734835], [2.932789013668642e-06, 0.25000008802341844, 0.47943778836468026, 0.7501336966324348, 0.9999993907509591, -0.19069247306967785], [0.03243672230777375, 0.25395321782067043, 0.34541972118299547, 0.7501326650624631, 0.9999998492641508, -0.19069435346691085], [0.0003033792973109005, 0.2500157402736446, 0.4794542457374668, 0.7500832587770462, 0.9999999767582022, -0.19069247306967785], [0.03245793458079349, 0.2500045685528398, 0.3454616506538218, 0.7500845487239469, 0.9999999720686634, -0.1999082195362705], [0.036362196292212684, 0.2447403304850069, 0.4794355045771112, 0.7515383315573292, 0.9999980075859624, -0.19915363462770788], [0.0003346262134147418, 0.24999892742544358, 0.47952120441809215, 0.7500865891690643, 0.9999999989667893, -0.19625196981331788], [1.9838435976419803e-06, 0.23034665448300337, 0.5001430297194803, 0.7501243555275898, 0.9999999936293775, -0.02072053260734835], [0.03245793458079349, 0.2500010733347597, 0.47993639718760045, 0.7501340017608054, 0.9999999622017649, -0.19955949644249923], [0.03245793458079349, 0.2500010733347597, 0.47993639718760045, 0.7501340017608054, 0.9999999622017649, -0.19955949644249923], [1.9838435976419803e-06, 0.23034665448300337, 0.5001430297194803, 0.7501243555275898, 0.9999999936293775, -0.02072053260734835]]

scenario1 = Scenario(name='Test Scenario',
                     asteroid_states=[
                         {'position': (400, 300), 'angle': 180, 'speed': 40},
                         {'position': (450, 250), 'angle': 180, 'speed': 40},
                         {'position': (500, 300), 'angle': 180, 'speed': 40},
                         {'position': (600, 400), 'angle': 180, 'speed': 40},
                         {'position': (500, 500), 'angle': 180, 'speed': 40},
                         {'position': (450, 550), 'angle': 180, 'speed': 40},
                         {'position': (400, 500), 'angle': 180, 'speed': 40},
                         {'position': (300, 400), 'angle': 180, 'speed': 40},

                     ],
                     ship_states=[
                         {'position': (400, 400), 'angle': 90, 'lives': 5, 'team': 1},
                         {'position': (500, 400), 'angle': 90, 'lives': 5, 'team': 2},
                     ],
                     map_size=(1000, 800),
                     time_limit=60,
                     ammo_limit_multiplier=0,
                     stop_if_no_ammo=False)
# 隕石が縦に並び，横向きに流れる
scenario2 = Scenario(

    asteroid_states=[
        {'position': (100, 100), 'angle': 180, 'speed': 120},
        {'position': (100, 200), 'angle': 180, 'speed': 120},
        {'position': (100, 300), 'angle': 180, 'speed': 120},
        {'position': (100, 400), 'angle': 180, 'speed': 120},
        {'position': (100, 500), 'angle': 180, 'speed': 120},
        {'position': (100, 600), 'angle': 180, 'speed': 120},
        {'position': (100, 700), 'angle': 180, 'speed': 120},

    ],
    ship_states=[
        {'position': (400, 300), 'angle': 90, 'lives': 5, 'team': 1},
        {'position': (400, 500), 'angle': 90, 'lives': 5, 'team': 2},
    ],
    map_size=(1000, 800),
    time_limit=60,
    ammo_limit_multiplier=0,
    stop_if_no_ammo=False)

# 2機体を囲むような円が迫ってくる
scenario3 = Scenario(

    asteroid_states=[
        {'position': (895.9285948, 456.9258097), 'angle': -171.81819999515864, 'speed': 20},
        {'position': (863.8528509, 566.1658897), 'angle': -155.45456364305159, 'speed': 20},
        {'position': (802.2999129, 661.9441976), 'angle': -139.09092728124793, 'speed': 20},
        {'position': (716.2564338, 736.5013445), 'angle': -122.72729091386054, 'speed': 20},
        {'position': (612.6931445, 783.7971537), 'angle': -106.36365454099587, 'speed': 20},
        {'position': (500.0001269, 800), 'angle': -90.00001817708605, 'speed': 20},
        {'position': (387.3070991, 783.7972252), 'angle': -73.63638182411489, 'speed': 20},
        {'position': (283.7437798, 736.5014818), 'angle': -57.272745457749366, 'speed': 20},
        {'position': (197.7002534, 661.9443895), 'angle': -40.90910909178643, 'speed': 20},
        {'position': (136.1472546, 566.1661207), 'angle': -24.54547273278905, 'speed': 20},
        {'position': (104.0714413, 456.926061), 'angle': -8.181836370428783, 'speed': 20},
        {'position': (104.0714052, 343.0741903), 'angle': 8.181800004841364, 'speed': 20},
        {'position': (136.1471491, 233.8341103), 'angle': 24.545436356948443, 'speed': 20},
        {'position': (197.7000871, 138.0558024), 'angle': 40.90907271875204, 'speed': 20},
        {'position': (283.7435662, 63.49865549), 'angle': 57.27270908691388, 'speed': 20},
        {'position': (387.3068555, 16.20284632), 'angle': 73.63634545819701, 'speed': 20},
        {'position': (499.9998731, 2.09752E-11), 'angle': 89.99998182291395, 'speed': 20},
        {'position': (612.6929009, 16.20277479), 'angle': 106.36361817548156, 'speed': 20},
        {'position': (716.2562202, 63.49851824), 'angle': 122.72725454534827, 'speed': 20},
        {'position': (802.2997466, 138.0556105), 'angle': 139.0908909082136, 'speed': 20},
        {'position': (863.8527454, 233.8338793), 'angle': 155.45452726721095, 'speed': 20},
        {'position': (895.9285587, 343.073939), 'angle': 171.81816362957122, 'speed': 20},

    ],
    ship_states=[
        {'position': (300, 400), 'angle': 90, 'lives': 3, 'team': 1},
        {'position': (700, 400), 'angle': 90, 'lives': 3, 'team': 2},

    ],
    map_size=(1000, 800),
    time_limit=60,
    ammo_limit_multiplier=0,
    stop_if_no_ammo=False)


def timeout(input_data):
    # Function for testing the timing out by the simulation environment
    wait_time = random.uniform(0.02, 0.03)
    time.sleep(wait_time)


def cil_run():
    if __name__ == "__main__":
        # Available settings


        # Instantiate an instance of FuzzyAsteroidGame
        game = KesslerGame()
        scenario_ship = accuracy_test_6
        new_gene = [-422.98248909, -128.46239109, 415.65025775, -339.31340805, -82.99984531,
                    157.18145777, 94.03193966, 74.20410544, -141.6155565, 66.7441948,
                    105.5832539, 136.26770441, 440.24368511, -32.15986455, -269.37155599,
                    -3.07185922, 180.0, -17.52924744, -11.0651477, 115.48644365,
                    45.6119877, 66.20575568, 85.31037087, 156.41788735, 13.28000091,
                    75.04230663, 145.83883738, -5.34633099, 79.93202705, 170.01952603,]
        out = [-0.7088955072188742, 0.8214190295038772, 0.7112301190262028, 0.6236911738917255, -0.5483281380747251, 0.26561341307694053, -0.7294564052157166, -0.46943564817126726, 0.07778984595456795, 0.27638052772492144, -0.8316403510049373, 0.18353860645220688, 0.049324020638467275, -0.8609177230308408, -0.596544549176398, -0.8212207659043411, -0.9188620135889307, -0.34475562599225007, 0.3764052779940773, -0.5404080051019365, 0.5388776640712046, 0.18985813020474723, -0.02037876260198057, -0.5412866226282118, 0.03369841522601849, -0.4104019167895155, -0.9327354415618214, 0.31011267886333593, 0.8377732938352088, 0.5168642888602355]
        out = np.array(out)
        out[:15] *= 480
        out[15:] *= 180
        thesis_out = [-256.90468836081504, -29.16069010301797, -65.31422125084545, -331.9157181305821, 295.67337151810636,
                      -348.1987731947432, -352.67853876999266, 75.66536189564708, -115.4769926753548, 276.615127498858,
                      -431.46955789661445, 328.1792064752584, -139.33344564225007, -421.5980265815564, 128.32626918644615,
                      -64.94008831117719, 76.68599901742528, -69.52112197230828, -109.74132001412883, 76.62363998684559,
                      -160.12494679256298, 19.61048198975353, -49.94832516903231, -7.9531801264646225, -145.62142615430074,
                      -92.0482799920598, -179.1218562024806, -42.27985100533542, -105.54201848209276, -37.67742166580005]

        controllers = [CombinedController(), CombinedController()]
        pre = time.perf_counter()
        score, perf_data = game.run(scenario=scenario_ship, controllers=controllers)
        print('Scenario eval time: ' + str(time.perf_counter() - pre))
        print(score.stop_reason)
        print('Asteroids hit: ' + str([team.asteroids_hit for team in score.teams]))
        print('Deaths: ' + str([team.deaths for team in score.teams]))
        print('Accuracy: ' + str([team.accuracy for team in score.teams]))
        print('Mean eval time: ' + str([team.mean_eval_time for team in score.teams]))
        print(sum([team.deaths for team in score.teams]))
        print(sum([team.deaths for team in score.teams]))
        f1 = np.average([team.accuracy for team in score.teams])
        f2 = 1 - score.sim_time / 120 if sum([team.deaths for team in score.teams]) < 3 else score.sim_time / 120
        # 両方最大化
        print(f1, f2)

cil_run()



